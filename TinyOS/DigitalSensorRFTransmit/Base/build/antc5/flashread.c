/*
 * File: flashread.c
 * @autor: xlq, 2010-4
 * */
/* CC2430 FLASH READ CODE SPACE in bank 0
*/

/* use this to enable the LX51 user class */
#pragma userclass (code = bank0)




typedef signed char int8_t;
typedef short int16_t;
typedef long int32_t;
typedef unsigned char uint8_t;
typedef unsigned short uint16_t;
typedef unsigned long uint32_t;


#include "ioCC2530.h"

#define FLASH_BASE		   0x8000
	
#define PAGE_SHIFT		  11 // 2048
#define PAGE_SIZE		  (1L << PAGE_SHIFT)
	
#define BANK_SHIFT		  15 // 32K
#define BANK_SIZE		  (1L << BANK_SHIFT)
#define BANK_MAP_MASK	  7  // F256: 7, F128: 3
	
#define FLASH_DMA_CH 	  0


extern void *memcpy(void *s1, void *s2, int n);



uint8_t xdata writeFunctionBuffer[] = 
					{ 0x7B ,0x01 ,0x10 ,0xAF ,0x02 ,0x7B ,0x00 ,0xC0 ,0x83 ,0xC0 ,0x82 ,0xC0 ,0x85 ,0xC0 ,0x84 ,0xC0
 ,0x92 ,0xEA ,0xF5 ,0x83 ,0xE9 ,0xF5 ,0x82 ,0x75 ,0x92 ,0x01 ,0x75 ,0x85 ,0x62 ,0x75 ,0x84 ,0x70
 ,0xE0 ,0x54 ,0x80 ,0x70 ,0xFB ,0x74 ,0x02 ,0xF0 ,0xEC ,0x60 ,0x27 ,0x7A ,0x40 ,0x79 ,0x04 ,0x75
 ,0x92 ,0x00 ,0xE0 ,0xA3 ,0x75 ,0x92 ,0x01 ,0x75 ,0x85 ,0x62 ,0x75 ,0x84 ,0x73 ,0xF0 ,0xD9 ,0xEF
 ,0x74 ,0x00 ,0xF0 ,0x75 ,0x85 ,0x62 ,0x75 ,0x84 ,0x70 ,0xE0 ,0x54 ,0x40 ,0x70 ,0xFB ,0xDA ,0xDD
 ,0xDC ,0xD9 ,0xED ,0x60 ,0x29 ,0xED ,0x54 ,0xFC ,0x03 ,0x03 ,0xFD ,0x79 ,0x04 ,0x75 ,0x92 ,0x00
 ,0xE0 ,0xA3 ,0x75 ,0x92 ,0x01 ,0x75 ,0x85 ,0x62 ,0x75 ,0x84 ,0x73 ,0xF0 ,0xD9 ,0xEF ,0x74 ,0x00
 ,0xF0 ,0x75 ,0x85 ,0x62 ,0x75 ,0x84 ,0x70 ,0xE0 ,0x54 ,0x40 ,0x70 ,0xFB ,0xDD ,0xDD ,0xD0 ,0x92
 ,0xD0 ,0x84 ,0xD0 ,0x85 ,0xD0 ,0x82 ,0xD0 ,0x83 ,0xEB ,0x60 ,0x02 ,0xD2 ,0xAF ,0x22 };

void (*writeFunction)(uint8_t * buf, uint16_t length);


void HalFlashP__HalCC2530FlashRead(uint8_t * destination, uint32_t source, uint16_t length)
{
	uint8_t  old_map;
	uint8_t  bank;
	uint16_t offset;
	uint8_t old_ea;
		
	old_ea = EA;
	EA = 0;
	
	bank = (source >> BANK_SHIFT) & BANK_MAP_MASK;
	offset = (source & (BANK_SIZE - 1)) + FLASH_BASE;
	
	// save old xmap
	old_map = MEMCTR;
	
	// select new xmap
	MEMCTR = (old_map & ~0x7) | bank;
	
	memcpy((uint8_t xdata*)destination, (uint8_t xdata*)offset, length);
	
	// restore xmap
	MEMCTR = old_map;
	
	EA = old_ea;

}

void HalFlashP__HalCC2530FlashWrite(uint32_t destination, uint8_t * source, uint16_t length)
{
	uint8_t page, row, location;
	uint16_t old_map;
	uint8_t old_ea;
	
	old_ea = EA;
	EA = 0;

	page = (uint32_t) destination / 0x0800;
	row = ((uint32_t) destination % 0x0800) >> 8;
	location = (((uint32_t) destination % 0x0800) & 0xFF) >> 2;
	
	FADDRH = (page << 1) | (row >> 2);
	FADDRL = (row << 6) | location;
	
	old_map = MEMCTR;
	MEMCTR |= 0x08;
	
	writeFunction = (void(*)(uint8_t *, uint16_t)) (writeFunctionBuffer + 0x8000);
	writeFunction(source, length);
	
	// restore xmap
	MEMCTR = old_map;

	EA = old_ea;

}

